<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { color: #20794d; } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007ba5; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #007ba5; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #007ba5; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #20794d; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>

  <!--radix_placeholder_meta_tags-->
  <title>Google's Tensor Processing Unit</title>

  <meta property="description" itemprop="description" content="Just my incoherent thoughts on Google&#39;s TPUs."/>


  <!--  https://schema.org/Article -->
  <meta property="article:published" itemprop="datePublished" content="2021-05-22"/>
  <meta property="article:created" itemprop="dateCreated" content="2021-05-22"/>
  <meta name="article:author" content="Gunjan Payal"/>

  <!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
  <meta property="og:title" content="Google&#39;s Tensor Processing Unit"/>
  <meta property="og:type" content="article"/>
  <meta property="og:description" content="Just my incoherent thoughts on Google&#39;s TPUs."/>
  <meta property="og:locale" content="en_US"/>

  <!--  https://dev.twitter.com/cards/types/summary -->
  <meta property="twitter:card" content="summary"/>
  <meta property="twitter:title" content="Google&#39;s Tensor Processing Unit"/>
  <meta property="twitter:description" content="Just my incoherent thoughts on Google&#39;s TPUs."/>

  <!--/radix_placeholder_meta_tags-->
  
  <meta name="citation_reference" content="citation_title=50 Years of computer architecture: From the mainframe CPU to the domain-specific tpu and the open RISC-V instruction set;citation_publication_date=2018;citation_publisher=IEEE;citation_doi=10.1109/ISSCC.2018.8310168;citation_author=David Patterson"/>
  <meta name="citation_reference" content="citation_title=A Study of BFLOAT16 for Deep Learning Training;citation_publication_date=2019;citation_author=Dhiraj Kalamkar;citation_author=Dheevatsa Mudigere;citation_author=Naveen Mellempudi;citation_author=Dipankar Das;citation_author=Kunal Banerjee;citation_author=Sasikanth Avancha;citation_author=Dharma Teja Vooturi;citation_author=Nataraj Jammalamadaka;citation_author=Jianyu Huang;citation_author=Hector Yuen;citation_author=Jiyan Yang;citation_author=Jongsoo Park;citation_author=Alexander Heinecke;citation_author=Evangelos Georganas;citation_author=Sudarshan Srinivasan;citation_author=Abhisek Kundu;citation_author=Misha Smelyanskiy;citation_author=Bharat Kaul;citation_author=Pradeep Dubey"/>
  <meta name="citation_reference" content="citation_title=A Survey Comparing Specialized Hardware and Evolution in TPUs for Neural Networks;citation_publication_date=2020;citation_publisher=Institute of Electrical; Electronics Engineers Inc.;citation_doi=10.1109/INMIC50486.2020.9318136;citation_author=Amna Shahid;citation_author=Malaika Mushtaq"/>
  <meta name="citation_reference" content="citation_title=An in-depth look at Google’s first Tensor Processing Unit (TPU) | Google Cloud Blog;citation_publication_date=2017;citation_author=Kaz Sato;citation_author=Cliff Young;citation_author=David Patterson"/>
  <meta name="citation_reference" content="citation_title=BFloat16: The secret to high performance on Cloud TPUs;citation_publication_date=2019;citation_author=Shibo Wang"/>
  <meta name="citation_reference" content="citation_title=Forty-three ways of systolic matrix multiplication;citation_publication_date=2010;citation_volume=87;citation_doi=10.1080/00207160802275944;citation_issn=0020-7160;citation_author=I. Ž. Milovanović;citation_author=M P Bekakos;citation_author=I N Tselepis;citation_author=E. I. Milovanović"/>
  <meta name="citation_reference" content="citation_title=GPU Tensor Cores for fast Arithmetic Reductions;citation_publication_date=2020;citation_author=Cristóbal A Navarro;citation_author=Roberto Carrasco;citation_author=Ricardo J Barrientos;citation_author=Javier A Riquelme;citation_author=Raimundo Vega"/>
  <meta name="citation_reference" content="citation_title=In-Datacenter Performance Analysis of a Tensor Processing Unit;citation_publication_date=2017;citation_volume=45;citation_doi=10.1145/3140659.3080246;citation_issn=0163-5964;citation_author=Norman P. Jouppi;citation_author=Cliff Young;citation_author=Nishant Patil;citation_author=David Patterson;citation_author=Gaurav Agrawal;citation_author=Raminder Bajwa;citation_author=Sarah Bates;citation_author=Suresh Bhatia;citation_author=Nan Boden;citation_author=Al Borchers;citation_author=Rick Boyle;citation_author=Pierre-luc Cantin;citation_author=Clifford Chao;citation_author=Chris Clark;citation_author=Jeremy Coriell;citation_author=Mike Daley;citation_author=Matt Dau;citation_author=Jeffrey Dean;citation_author=Ben Gelb;citation_author=Tara Vazir Ghaemmaghami;citation_author=Rajendra Gottipati;citation_author=William Gulland;citation_author=Robert Hagmann;citation_author=C. Richard Ho;citation_author=Doug Hogberg;citation_author=John Hu;citation_author=Robert Hundt;citation_author=Dan Hurt;citation_author=Julian Ibarz;citation_author=Aaron Jaffey;citation_author=Alek Jaworski;citation_author=Alexander Kaplan;citation_author=Harshit Khaitan;citation_author=Daniel Killebrew;citation_author=Andy Koch;citation_author=Naveen Kumar;citation_author=Steve Lacy;citation_author=James Laudon;citation_author=James Law;citation_author=Diemthu Le;citation_author=Chris Leary;citation_author=Zhuyuan Liu;citation_author=Kyle Lucke;citation_author=Alan Lundin;citation_author=Gordon MacKean;citation_author=Adriana Maggiore;citation_author=Maire Mahony;citation_author=Kieran Miller;citation_author=Rahul Nagarajan;citation_author=Ravi Narayanaswami;citation_author=Ray Ni;citation_author=Kathy Nix;citation_author=Thomas Norrie;citation_author=Mark Omernick;citation_author=Narayana Penukonda;citation_author=Andy Phelps;citation_author=Jonathan Ross;citation_author=Matt Ross;citation_author=Amir Salek;citation_author=Emad Samadiani;citation_author=Chris Severn;citation_author=Gregory Sizikov;citation_author=Matthew Snelham;citation_author=Jed Souter;citation_author=Dan Steinberg;citation_author=Andy Swing;citation_author=Mercedes Tan;citation_author=Gregory Thorson;citation_author=Bo Tian;citation_author=Horia Toma;citation_author=Erick Tuttle;citation_author=Vijay Vasudevan;citation_author=Richard Walter;citation_author=Walter Wang;citation_author=Eric Wilcox;citation_author=Doe Hyun Yoon"/>
  <meta name="citation_reference" content="citation_title=Mapping Computational Concepts to GPUs Chapter 31 Excerpted from GPU Gems 2;citation_publication_date=2005;citation_author=Mark Harris"/>
  <meta name="citation_reference" content="citation_title=Motivation for and Evaluation of the First Tensor Processing Unit;citation_publication_date=2018;citation_volume=38;citation_doi=10.1109/MM.2018.032271057;citation_issn=0272-1732;citation_author=Norman Jouppi;citation_author=Cliff Young;citation_author=Nishant Patil;citation_author=David Patterson"/>
  <meta name="citation_reference" content="citation_title=PyTorch XLA;citation_publication_date=2020;citation_author=PyTorch XLA"/>
  <meta name="citation_reference" content="citation_title=Roofline: An insightful visual performance model for multicore architectures;citation_publication_date=2009;citation_volume=52;citation_doi=10.1145/1498765.1498785;citation_issn=00010782;citation_author=Samuel Williams;citation_author=Andrew Waterman;citation_author=David Patterson"/>
  <meta name="citation_reference" content="citation_title=Tearing Apart Google ’ s TPU 3 . 0 AI Coprocessor;citation_publication_date=2018;citation_author=Paul Teich"/>
  <meta name="citation_reference" content="citation_title=The VLIW Machine: A Multiprocessor for Compiling Scientific Code;citation_publication_date=1984;citation_author=Joseph A Fisher"/>
  <meta name="citation_reference" content="citation_title=Training deep neural networks with low precision multiplications;citation_publication_date=2014;citation_author=Matthieu Courbariaux;citation_author=Yoshua Bengio;citation_author=Jean-Pierre David"/>
  <meta name="citation_reference" content="citation_title=Why systolic architectures?;citation_publication_date=1982;citation_volume=15;citation_doi=10.1109/MC.1982.1653825;citation_issn=0018-9162;citation_author=Why systolic architectures?"/>
  <!--radix_placeholder_rmarkdown_metadata-->

  <script type="text/json" id="radix-rmarkdown-metadata">
  {"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","author","date","output","editor_options","bibliography"]}},"value":[{"type":"character","attributes":{},"value":["Google's Tensor Processing Unit"]},{"type":"character","attributes":{},"value":["Just my incoherent thoughts on Google's TPUs.\n"]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","url"]}},"value":[{"type":"character","attributes":{},"value":["Gunjan Payal"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":[]}},"value":[]}]}]},{"type":"character","attributes":{},"value":["05-22-2021"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["self_contained"]}},"value":[{"type":"logical","attributes":{},"value":[false]}]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["markdown"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["wrap"]}},"value":[{"type":"integer","attributes":{},"value":[72]}]}]},{"type":"character","attributes":{},"value":["references.bib"]}]}
  </script>
  <!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["googles-tensor-processing-unit_files/anchor-4.2.2/anchor.min.js","googles-tensor-processing-unit_files/bowser-1.9.3/bowser.min.js","googles-tensor-processing-unit_files/distill-2.2.21/template.v2.js","googles-tensor-processing-unit_files/header-attrs-2.8/header-attrs.js","googles-tensor-processing-unit_files/header-attrs-2.9/header-attrs.js","googles-tensor-processing-unit_files/jquery-1.11.3/jquery.min.js","googles-tensor-processing-unit_files/popper-2.6.0/popper.min.js","googles-tensor-processing-unit_files/tippy-6.2.7/tippy-bundle.umd.min.js","googles-tensor-processing-unit_files/tippy-6.2.7/tippy-light-border.css","googles-tensor-processing-unit_files/tippy-6.2.7/tippy.css","googles-tensor-processing-unit_files/tippy-6.2.7/tippy.umd.min.js","googles-tensor-processing-unit_files/webcomponents-2.0.0/webcomponents.js","images/1.png","images/2.png","images/3.png","images/4.png","images/5-01.png","images/5.png","images/6.png","images/7.png","images/8.png","images/HC32_ML_Training_Google_Norrie_Patil.v01 (dragged).png","images/Screenshot 2021-06-02 at 2.58.01 PM-01.png","images/Screenshot 2021-06-02 at 2.58.01 PM.png","images/Screenshot 2021-06-02 at 2.58.15 PM-01.png","images/Screenshot 2021-06-02 at 2.58.15 PM.png","images/TPUv1_Schematic-01.jpg","images/TPUv1_Schematic.jpg","images/TPUv2Core_Compiled-01.jpg","images/TPUv2Core_Compiled.jpg","references.bib","wheredafuck.bib"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->
  <!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

  <style type="text/css">

  body {
    background-color: white;
  }

  .pandoc-table {
    width: 100%;
  }

  .pandoc-table>caption {
    margin-bottom: 10px;
  }

  .pandoc-table th:not([align]) {
    text-align: left;
  }

  .pagedtable-footer {
    font-size: 15px;
  }

  d-byline .byline {
    grid-template-columns: 2fr 2fr;
  }

  d-byline .byline h3 {
    margin-block-start: 1.5em;
  }

  d-byline .byline .authors-affiliations h3 {
    margin-block-start: 0.5em;
  }

  .authors-affiliations .orcid-id {
    width: 16px;
    height:16px;
    margin-left: 4px;
    margin-right: 4px;
    vertical-align: middle;
    padding-bottom: 2px;
  }

  d-title .dt-tags {
    margin-top: 1em;
    grid-column: text;
  }

  .dt-tags .dt-tag {
    text-decoration: none;
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0em 0.4em;
    margin-right: 0.5em;
    margin-bottom: 0.4em;
    font-size: 70%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  d-article table.gt_table td,
  d-article table.gt_table th {
    border-bottom: none;
  }

  .html-widget {
    margin-bottom: 2.0em;
  }

  .l-screen-inset {
    padding-right: 16px;
  }

  .l-screen .caption {
    margin-left: 10px;
  }

  .shaded {
    background: rgb(247, 247, 247);
    padding-top: 20px;
    padding-bottom: 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .html-widget {
    margin-bottom: 0;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .shaded-content {
    background: white;
  }

  .text-output {
    margin-top: 0;
    line-height: 1.5em;
  }

  .hidden {
    display: none !important;
  }

  d-article {
    padding-top: 2.5rem;
    padding-bottom: 30px;
  }

  d-appendix {
    padding-top: 30px;
  }

  d-article>p>img {
    width: 100%;
  }

  d-article h2 {
    margin: 1rem 0 1.5rem 0;
  }

  d-article h3 {
    margin-top: 1.5rem;
  }

  d-article iframe {
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 2.0em;
    width: 100%;
  }

  /* Tweak code blocks */

  d-article div.sourceCode code,
  d-article pre code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: auto;
  }

  d-article div.sourceCode {
    background-color: white;
  }

  d-article div.sourceCode pre {
    padding-left: 10px;
    font-size: 12px;
    border-left: 2px solid rgba(0,0,0,0.1);
  }

  d-article pre {
    font-size: 12px;
    color: black;
    background: none;
    margin-top: 0;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  d-article pre a {
    border-bottom: none;
  }

  d-article pre a:hover {
    border-bottom: none;
    text-decoration: underline;
  }

  d-article details {
    grid-column: text;
    margin-bottom: 0.8em;
  }

  @media(min-width: 768px) {

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: visible !important;
  }

  d-article div.sourceCode pre {
    padding-left: 18px;
    font-size: 14px;
  }

  d-article pre {
    font-size: 14px;
  }

  }

  figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  /* CSS for d-contents */

  .d-contents {
    grid-column: text;
    color: rgba(0,0,0,0.8);
    font-size: 0.9em;
    padding-bottom: 1em;
    margin-bottom: 1em;
    padding-bottom: 0.5em;
    margin-bottom: 1em;
    padding-left: 0.25em;
    justify-self: start;
  }

  @media(min-width: 1000px) {
    .d-contents.d-contents-float {
      height: 0;
      grid-column-start: 1;
      grid-column-end: 4;
      justify-self: center;
      padding-right: 3em;
      padding-left: 2em;
    }
  }

  .d-contents nav h3 {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 1em;
  }

  .d-contents li {
    list-style-type: none
  }

  .d-contents nav > ul {
    padding-left: 0;
  }

  .d-contents ul {
    padding-left: 1em
  }

  .d-contents nav ul li {
    margin-top: 0.6em;
    margin-bottom: 0.2em;
  }

  .d-contents nav a {
    font-size: 13px;
    border-bottom: none;
    text-decoration: none
    color: rgba(0, 0, 0, 0.8);
  }

  .d-contents nav a:hover {
    text-decoration: underline solid rgba(0, 0, 0, 0.6)
  }

  .d-contents nav > ul > li > a {
    font-weight: 600;
  }

  .d-contents nav > ul > li > ul {
    font-weight: inherit;
  }

  .d-contents nav > ul > li > ul > li {
    margin-top: 0.2em;
  }


  .d-contents nav ul {
    margin-top: 0;
    margin-bottom: 0.25em;
  }

  .d-article-with-toc h2:nth-child(2) {
    margin-top: 0;
  }


  /* Figure */

  .figure {
    position: relative;
    margin-bottom: 2.5em;
    margin-top: 1.5em;
  }

  .figure img {
    width: 100%;
  }

  .figure .caption {
    color: rgba(0, 0, 0, 0.6);
    font-size: 12px;
    line-height: 1.5em;
  }

  .figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  .figure .caption a {
    color: rgba(0, 0, 0, 0.6);
  }

  .figure .caption b,
  .figure .caption strong, {
    font-weight: 600;
    color: rgba(0, 0, 0, 1.0);
  }

  /* Citations */

  d-article .citation {
    color: inherit;
    cursor: inherit;
  }

  div.hanging-indent{
    margin-left: 1em; text-indent: -1em;
  }

  /* Citation hover box */

  .tippy-box[data-theme~=light-border] {
    background-color: rgba(250, 250, 250, 0.95);
  }

  .tippy-content > p {
    margin-bottom: 0;
    padding: 2px;
  }


  /* Tweak 1000px media break to show more text */

  @media(min-width: 1000px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 16px;
    }

    .grid {
      grid-column-gap: 16px;
    }

    d-article {
      font-size: 1.06rem;
      line-height: 1.7em;
    }
    figure .caption, .figure .caption, figure figcaption {
      font-size: 13px;
    }
  }

  @media(min-width: 1180px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 32px;
    }

    .grid {
      grid-column-gap: 32px;
    }
  }


  /* Get the citation styles for the appendix (not auto-injected on render since
     we do our own rendering of the citation appendix) */

  d-appendix .citation-appendix,
  .d-appendix .citation-appendix {
    font-size: 11px;
    line-height: 15px;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
    padding-left: 18px;
    border: 1px solid rgba(0,0,0,0.1);
    background: rgba(0, 0, 0, 0.02);
    padding: 10px 18px;
    border-radius: 3px;
    color: rgba(150, 150, 150, 1);
    overflow: hidden;
    margin-top: -12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  /* Include appendix styles here so they can be overridden */

  d-appendix {
    contain: layout style;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-top: 60px;
    margin-bottom: 0;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    color: rgba(0,0,0,0.5);
    padding-top: 60px;
    padding-bottom: 48px;
  }

  d-appendix h3 {
    grid-column: page-start / text-start;
    font-size: 15px;
    font-weight: 500;
    margin-top: 1em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.65);
  }

  d-appendix h3 + * {
    margin-top: 1em;
  }

  d-appendix ol {
    padding: 0 0 0 15px;
  }

  @media (min-width: 768px) {
    d-appendix ol {
      padding: 0 0 0 30px;
      margin-left: -30px;
    }
  }

  d-appendix li {
    margin-bottom: 1em;
  }

  d-appendix a {
    color: rgba(0, 0, 0, 0.6);
  }

  d-appendix > * {
    grid-column: text;
  }

  d-appendix > d-footnote-list,
  d-appendix > d-citation-list,
  d-appendix > distill-appendix {
    grid-column: screen;
  }

  /* Include footnote styles here so they can be overridden */

  d-footnote-list {
    contain: layout style;
  }

  d-footnote-list > * {
    grid-column: text;
  }

  d-footnote-list a.footnote-backlink {
    color: rgba(0,0,0,0.3);
    padding-left: 0.5em;
  }



  /* Anchor.js */

  .anchorjs-link {
    /*transition: all .25s linear; */
    text-decoration: none;
    border-bottom: none;
  }
  *:hover > .anchorjs-link {
    margin-left: -1.125em !important;
    text-decoration: none;
    border-bottom: none;
  }

  /* Social footer */

  .social_footer {
    margin-top: 30px;
    margin-bottom: 0;
    color: rgba(0,0,0,0.67);
  }

  .disqus-comments {
    margin-right: 30px;
  }

  .disqus-comment-count {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
    cursor: pointer;
  }

  #disqus_thread {
    margin-top: 30px;
  }

  .article-sharing a {
    border-bottom: none;
    margin-right: 8px;
  }

  .article-sharing a:hover {
    border-bottom: none;
  }

  .sidebar-section.subscribe {
    font-size: 12px;
    line-height: 1.6em;
  }

  .subscribe p {
    margin-bottom: 0.5em;
  }


  .article-footer .subscribe {
    font-size: 15px;
    margin-top: 45px;
  }


  .sidebar-section.custom {
    font-size: 12px;
    line-height: 1.6em;
  }

  .custom p {
    margin-bottom: 0.5em;
  }

  /* Styles for listing layout (hide title) */
  .layout-listing d-title, .layout-listing .d-title {
    display: none;
  }

  /* Styles for posts lists (not auto-injected) */


  .posts-with-sidebar {
    padding-left: 45px;
    padding-right: 45px;
  }

  .posts-list .description h2,
  .posts-list .description p {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  }

  .posts-list .description h2 {
    font-weight: 700;
    border-bottom: none;
    padding-bottom: 0;
  }

  .posts-list h2.post-tag {
    border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    padding-bottom: 12px;
  }
  .posts-list {
    margin-top: 60px;
    margin-bottom: 24px;
  }

  .posts-list .post-preview {
    text-decoration: none;
    overflow: hidden;
    display: block;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    padding: 24px 0;
  }

  .post-preview-last {
    border-bottom: none !important;
  }

  .posts-list .posts-list-caption {
    grid-column: screen;
    font-weight: 400;
  }

  .posts-list .post-preview h2 {
    margin: 0 0 6px 0;
    line-height: 1.2em;
    font-style: normal;
    font-size: 24px;
  }

  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.4em;
    font-size: 16px;
  }

  .posts-list .post-preview .thumbnail {
    box-sizing: border-box;
    margin-bottom: 24px;
    position: relative;
    max-width: 500px;
  }
  .posts-list .post-preview img {
    width: 100%;
    display: block;
  }

  .posts-list .metadata {
    font-size: 12px;
    line-height: 1.4em;
    margin-bottom: 18px;
  }

  .posts-list .metadata > * {
    display: inline-block;
  }

  .posts-list .metadata .publishedDate {
    margin-right: 2em;
  }

  .posts-list .metadata .dt-authors {
    display: block;
    margin-top: 0.3em;
    margin-right: 2em;
  }

  .posts-list .dt-tags {
    display: block;
    line-height: 1em;
  }

  .posts-list .dt-tags .dt-tag {
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0.3em 0.4em;
    margin-right: 0.2em;
    margin-bottom: 0.4em;
    font-size: 60%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  .posts-list img {
    opacity: 1;
  }

  .posts-list img[data-src] {
    opacity: 0;
  }

  .posts-more {
    clear: both;
  }


  .posts-sidebar {
    font-size: 16px;
  }

  .posts-sidebar h3 {
    font-size: 16px;
    margin-top: 0;
    margin-bottom: 0.5em;
    font-weight: 400;
    text-transform: uppercase;
  }

  .sidebar-section {
    margin-bottom: 30px;
  }

  .categories ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }

  .categories li {
    color: rgba(0, 0, 0, 0.8);
    margin-bottom: 0;
  }

  .categories li>a {
    border-bottom: none;
  }

  .categories li>a:hover {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  }

  .categories .active {
    font-weight: 600;
  }

  .categories .category-count {
    color: rgba(0, 0, 0, 0.4);
  }


  @media(min-width: 768px) {
    .posts-list .post-preview h2 {
      font-size: 26px;
    }
    .posts-list .post-preview .thumbnail {
      float: right;
      width: 30%;
      margin-bottom: 0;
    }
    .posts-list .post-preview .description {
      float: left;
      width: 45%;
    }
    .posts-list .post-preview .metadata {
      float: left;
      width: 20%;
      margin-top: 8px;
    }
    .posts-list .post-preview p {
      margin: 0 0 12px 0;
      line-height: 1.5em;
      font-size: 16px;
    }
    .posts-with-sidebar .posts-list {
      float: left;
      width: 75%;
    }
    .posts-with-sidebar .posts-sidebar {
      float: right;
      width: 20%;
      margin-top: 60px;
      padding-top: 24px;
      padding-bottom: 24px;
    }
  }


  /* Improve display for browsers without grid (IE/Edge <= 15) */

  .downlevel {
    line-height: 1.6em;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    margin: 0;
  }

  .downlevel .d-title {
    padding-top: 6rem;
    padding-bottom: 1.5rem;
  }

  .downlevel .d-title h1 {
    font-size: 50px;
    font-weight: 700;
    line-height: 1.1em;
    margin: 0 0 0.5rem;
  }

  .downlevel .d-title p {
    font-weight: 300;
    font-size: 1.2rem;
    line-height: 1.55em;
    margin-top: 0;
  }

  .downlevel .d-byline {
    padding-top: 0.8em;
    padding-bottom: 0.8em;
    font-size: 0.8rem;
    line-height: 1.8em;
  }

  .downlevel .section-separator {
    border: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }

  .downlevel .d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
    padding-top: 1rem;
    padding-bottom: 2rem;
  }


  .downlevel .d-appendix {
    padding-left: 0;
    padding-right: 0;
    max-width: none;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.5);
    padding-top: 40px;
    padding-bottom: 48px;
  }

  .downlevel .footnotes ol {
    padding-left: 13px;
  }

  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
    padding-left: 40px;
    padding-right: 40px;
  }

  @media(min-width: 768px) {
    .downlevel .base-grid,
    .downlevel .distill-header,
    .downlevel .d-title,
    .downlevel .d-abstract,
    .downlevel .d-article,
    .downlevel .d-appendix,
    .downlevel .distill-appendix,
    .downlevel .d-byline,
    .downlevel .d-footnote-list,
    .downlevel .d-citation-list,
    .downlevel .distill-footer,
    .downlevel .appendix-bottom,
    .downlevel .posts-container {
    padding-left: 150px;
    padding-right: 150px;
    max-width: 900px;
  }
  }

  .downlevel pre code {
    display: block;
    border-left: 2px solid rgba(0, 0, 0, .1);
    padding: 0 0 0 20px;
    font-size: 14px;
  }

  .downlevel code, .downlevel pre {
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  .downlevel .posts-list .post-preview {
    color: inherit;
  }



  </style>

  <script type="application/javascript">

  function is_downlevel_browser() {
    if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                   window.navigator.userAgent)) {
      return true;
    } else {
      return window.load_distill_framework === undefined;
    }
  }

  // show body when load is complete
  function on_load_complete() {

    // add anchors
    if (window.anchors) {
      window.anchors.options.placement = 'left';
      window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
    }


    // set body to visible
    document.body.style.visibility = 'visible';

    // force redraw for leaflet widgets
    if (window.HTMLWidgets) {
      var maps = window.HTMLWidgets.findAll(".leaflet");
      $.each(maps, function(i, el) {
        var map = this.getMap();
        map.invalidateSize();
        map.eachLayer(function(layer) {
          if (layer instanceof L.TileLayer)
            layer.redraw();
        });
      });
    }

    // trigger 'shown' so htmlwidgets resize
    $('d-article').trigger('shown');
  }

  function init_distill() {

    init_common();

    // create front matter
    var front_matter = $('<d-front-matter></d-front-matter>');
    $('#distill-front-matter').wrap(front_matter);

    // create d-title
    $('.d-title').changeElementType('d-title');

    // create d-byline
    var byline = $('<d-byline></d-byline>');
    $('.d-byline').replaceWith(byline);

    // create d-article
    var article = $('<d-article></d-article>');
    $('.d-article').wrap(article).children().unwrap();

    // move posts container into article
    $('.posts-container').appendTo($('d-article'));

    // create d-appendix
    $('.d-appendix').changeElementType('d-appendix');

    // flag indicating that we have appendix items
    var appendix = $('.appendix-bottom').children('h3').length > 0;

    // replace footnotes with <d-footnote>
    $('.footnote-ref').each(function(i, val) {
      appendix = true;
      var href = $(this).attr('href');
      var id = href.replace('#', '');
      var fn = $('#' + id);
      var fn_p = $('#' + id + '>p');
      fn_p.find('.footnote-back').remove();
      var text = fn_p.html();
      var dtfn = $('<d-footnote></d-footnote>');
      dtfn.html(text);
      $(this).replaceWith(dtfn);
    });
    // remove footnotes
    $('.footnotes').remove();

    // move refs into #references-listing
    $('#references-listing').replaceWith($('#refs'));

    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      var id = $(this).attr('id');
      $('.d-contents a[href="#' + id + '"]').parent().remove();
      appendix = true;
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
    });

    // show d-appendix if we have appendix content
    $("d-appendix").css('display', appendix ? 'grid' : 'none');

    // localize layout chunks to just output
    $('.layout-chunk').each(function(i, val) {

      // capture layout
      var layout = $(this).attr('data-layout');

      // apply layout to markdown level block elements
      var elements = $(this).children().not('details, div.sourceCode, pre, script');
      elements.each(function(i, el) {
        var layout_div = $('<div class="' + layout + '"></div>');
        if (layout_div.hasClass('shaded')) {
          var shaded_content = $('<div class="shaded-content"></div>');
          $(this).wrap(shaded_content);
          $(this).parent().wrap(layout_div);
        } else {
          $(this).wrap(layout_div);
        }
      });


      // unwrap the layout-chunk div
      $(this).children().unwrap();
    });

    // remove code block used to force  highlighting css
    $('.distill-force-highlighting-css').parent().remove();

    // remove empty line numbers inserted by pandoc when using a
    // custom syntax highlighting theme
    $('code.sourceCode a:empty').remove();

    // load distill framework
    load_distill_framework();

    // wait for window.distillRunlevel == 4 to do post processing
    function distill_post_process() {

      if (!window.distillRunlevel || window.distillRunlevel < 4)
        return;

      // hide author/affiliations entirely if we have no authors
      var front_matter = JSON.parse($("#distill-front-matter").html());
      var have_authors = front_matter.authors && front_matter.authors.length > 0;
      if (!have_authors)
        $('d-byline').addClass('hidden');

      // article with toc class
      $('.d-contents').parent().addClass('d-article-with-toc');

      // strip links that point to #
      $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

      // add orcid ids
      $('.authors-affiliations').find('.author').each(function(i, el) {
        var orcid_id = front_matter.authors[i].orcidID;
        if (orcid_id) {
          var a = $('<a></a>');
          a.attr('href', 'https://orcid.org/' + orcid_id);
          var img = $('<img></img>');
          img.addClass('orcid-id');
          img.attr('alt', 'ORCID ID');
          img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
          a.append(img);
          $(this).append(a);
        }
      });

      // hide elements of author/affiliations grid that have no value
      function hide_byline_column(caption) {
        $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
      }

      // affiliations
      var have_affiliations = false;
      for (var i = 0; i<front_matter.authors.length; ++i) {
        var author = front_matter.authors[i];
        if (author.affiliation !== "&nbsp;") {
          have_affiliations = true;
          break;
        }
      }
      if (!have_affiliations)
        $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

      // published date
      if (!front_matter.publishedDate)
        hide_byline_column("Published");

      // document object identifier
      var doi = $('d-byline').find('h3:contains("DOI")');
      var doi_p = doi.next().empty();
      if (!front_matter.doi) {
        // if we have a citation and valid citationText then link to that
        if ($('#citation').length > 0 && front_matter.citationText) {
          doi.html('Citation');
          $('<a href="#citation"></a>')
            .text(front_matter.citationText)
            .appendTo(doi_p);
        } else {
          hide_byline_column("DOI");
        }
      } else {
        $('<a></a>')
           .attr('href', "https://doi.org/" + front_matter.doi)
           .html(front_matter.doi)
           .appendTo(doi_p);
      }

       // change plural form of authors/affiliations
      if (front_matter.authors.length === 1) {
        var grid = $('.authors-affiliations');
        grid.children('h3:contains("Authors")').text('Author');
        grid.children('h3:contains("Affiliations")').text('Affiliation');
      }

      // remove d-appendix and d-footnote-list local styles
      $('d-appendix > style:first-child').remove();
      $('d-footnote-list > style:first-child').remove();

      // move appendix-bottom entries to the bottom
      $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
      $('.appendix-bottom').remove();

      // hoverable references
      $('span.citation[data-cites]').each(function() {
        var refHtml = $('#ref-' + $(this).attr('data-cites')).html();
        window.tippy(this, {
          allowHTML: true,
          content: refHtml,
          maxWidth: 500,
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start'
        });
      });

      // clear polling timer
      clearInterval(tid);

      // show body now that everything is ready
      on_load_complete();
    }

    var tid = setInterval(distill_post_process, 50);
    distill_post_process();

  }

  function init_downlevel() {

    init_common();

     // insert hr after d-title
    $('.d-title').after($('<hr class="section-separator"/>'));

    // check if we have authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;

    // manage byline/border
    if (!have_authors)
      $('.d-byline').remove();
    $('.d-byline').after($('<hr class="section-separator"/>'));
    $('.d-byline a').remove();

    // remove toc
    $('.d-contents').remove();

    // move appendix elements
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
    });


    // inject headers into references and footnotes
    var refs_header = $('<h3></h3>');
    refs_header.text('References');
    $('#refs').prepend(refs_header);

    var footnotes_header = $('<h3></h3');
    footnotes_header.text('Footnotes');
    $('.footnotes').children('hr').first().replaceWith(footnotes_header);

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // remove appendix if it's empty
    if ($('.d-appendix').children().length === 0)
      $('.d-appendix').remove();

    // prepend separator above appendix
    $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

    // trim code
    $('pre>code').each(function(i, val) {
      $(this).html($.trim($(this).html()));
    });

    // move posts-container right before article
    $('.posts-container').insertBefore($('.d-article'));

    $('body').addClass('downlevel');

    on_load_complete();
  }


  function init_common() {

    // jquery plugin to change element types
    (function($) {
      $.fn.changeElementType = function(newType) {
        var attrs = {};

        $.each(this[0].attributes, function(idx, attr) {
          attrs[attr.nodeName] = attr.nodeValue;
        });

        this.replaceWith(function() {
          return $("<" + newType + "/>", attrs).append($(this).contents());
        });
      };
    })(jQuery);

    // prevent underline for linked images
    $('a > img').parent().css({'border-bottom' : 'none'});

    // mark non-body figures created by knitr chunks as 100% width
    $('.layout-chunk').each(function(i, val) {
      var figures = $(this).find('img, .html-widget');
      if ($(this).attr('data-layout') !== "l-body") {
        figures.css('width', '100%');
      } else {
        figures.css('max-width', '100%');
        figures.filter("[width]").each(function(i, val) {
          var fig = $(this);
          fig.css('width', fig.attr('width') + 'px');
        });

      }
    });

    // auto-append index.html to post-preview links in file: protocol
    // and in rstudio ide preview
    $('.post-preview').each(function(i, val) {
      if (window.location.protocol === "file:")
        $(this).attr('href', $(this).attr('href') + "index.html");
    });

    // get rid of index.html references in header
    if (window.location.protocol !== "file:") {
      $('.distill-site-header a[href]').each(function(i,val) {
        $(this).attr('href', $(this).attr('href').replace("index.html", "./"));
      });
    }

    // add class to pandoc style tables
    $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
    $('.kable-table').children('table').addClass('pandoc-table');

    // add figcaption style to table captions
    $('caption').parent('table').addClass("figcaption");

    // initialize posts list
    if (window.init_posts_list)
      window.init_posts_list();

    // implmement disqus comment link
    $('.disqus-comment-count').click(function() {
      window.headroom_prevent_pin = true;
      $('#disqus_thread').toggleClass('hidden');
      if (!$('#disqus_thread').hasClass('hidden')) {
        var offset = $(this).offset();
        $(window).resize();
        $('html, body').animate({
          scrollTop: offset.top - 35
        });
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    if (is_downlevel_browser())
      init_downlevel();
    else
      window.addEventListener('WebComponentsReady', init_distill);
  });

  </script>

  <!--/radix_placeholder_distill-->
  <script src="googles-tensor-processing-unit_files/header-attrs-2.9/header-attrs.js"></script>
  <script src="googles-tensor-processing-unit_files/jquery-1.11.3/jquery.min.js"></script>
  <script src="googles-tensor-processing-unit_files/popper-2.6.0/popper.min.js"></script>
  <link href="googles-tensor-processing-unit_files/tippy-6.2.7/tippy.css" rel="stylesheet" />
  <link href="googles-tensor-processing-unit_files/tippy-6.2.7/tippy-light-border.css" rel="stylesheet" />
  <script src="googles-tensor-processing-unit_files/tippy-6.2.7/tippy.umd.min.js"></script>
  <script src="googles-tensor-processing-unit_files/anchor-4.2.2/anchor.min.js"></script>
  <script src="googles-tensor-processing-unit_files/bowser-1.9.3/bowser.min.js"></script>
  <script src="googles-tensor-processing-unit_files/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="googles-tensor-processing-unit_files/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
  <!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Google's Tensor Processing Unit","description":"Just my incoherent thoughts on Google's TPUs.","authors":[{"author":"Gunjan Payal","authorURL":{},"affiliation":"&nbsp;","affiliationURL":"#","orcidID":""}],"publishedDate":"2021-05-22T00:00:00.000+00:00","citationText":"Payal, 2021"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Google’s Tensor Processing Unit</h1>
<!--radix_placeholder_categories-->
<!--/radix_placeholder_categories-->
<p><p>Just my incoherent thoughts on Google’s TPUs.</p></p>
</div>

<div class="d-byline">
  Gunjan Payal true 
  
<br/>05-22-2021
</div>

<div class="d-article">
<h1 id="theoretical-background">Theoretical Background</h1>
<p>GPUs originated from the gaming community because a CPU could not handle specialised tasks such as rasterisation, texture mapping, frame buffer operations etc <span class="citation" data-cites="Harris2005Mapping2"><a href="#ref-Harris2005Mapping2" role="doc-biblioref">Harris</a> (<a href="#ref-Harris2005Mapping2" role="doc-biblioref">2005</a>)</span>. The deep learning community adopted GPUs and has continued to use them and extend their capabilities<span class="citation" data-cites="Navarro2020GPUReductions">(<a href="#ref-Navarro2020GPUReductions" role="doc-biblioref">Navarro et al. 2020</a>)</span>.</p>
<p>However, further performance gains could not be extracted via the addition of transistors alone. As a more spearheaded approach, TPUs were conceived with the idea<span class="citation" data-cites="Jouppi2018MotivationUnitb">(<a href="#ref-Jouppi2018MotivationUnitb" role="doc-biblioref">N. Jouppi et al. 2018</a>)</span> that removing graphics capabilities and focusing on matrix multiplication capabilities could lead to better performance and power efficiency.</p>
<p><br />
As is the case with a lot of new advancements, the theoretical component needed to make this leap already existed. Work on <em>systolic matrix multiplication</em> had existed since the 1980s and it was put to use in TPUs.</p>
<p>Three versions of TPUs have been released with v2 and v3 being accessible to the general public via Google Cloud.</p>
<h2 id="systolic-architectures">Systolic Architectures</h2>
<p>Systolic architecture design is a general methodology for mapping high level computations into hardware structures developed at Carnegie Melon University around 1980<span class="citation" data-cites="Kung1982WhyArchitectures">(<a href="#ref-Kung1982WhyArchitectures" role="doc-biblioref">Kung 1982</a>)</span>.</p>
<p><br />
Systolic architecture gets its name from analogising the human heart, which pumps oxygenated blood throughout the body and receives de-oxygenated blood back from the organs with a computer’s memory, which <em>pumps</em> data throughout the processing units and gets processed data back.<br />
When the number of operations is greater than the total number of I/O elements, the task is said to be <em>“Compute Bound”</em>. In the reverse case, the task is said to be <em>“I/O bound”</em>. As an example, matrix multiplication is a compute bound task while matrix addition is an I/O bound task.<span class="citation" data-cites="Williams2009Roofline:Architecturesb">(<a href="#ref-Williams2009Roofline:Architecturesb" role="doc-biblioref">Williams, Waterman, and Patterson 2009</a>)</span></p>
<p><br />
Systolic architectures have found applications in various mathematical computations <span class="citation" data-cites="Milovanovic2010Forty-threeMultiplication">(<a href="#ref-Milovanovic2010Forty-threeMultiplication" role="doc-biblioref">Milovanović et al. 2010</a>)</span> but they can only speed up tasks that are compute bound.</p>
<h1 id="evolution-of-tpus">Evolution of TPUs</h1>
<h2 id="tpuv1">TPUv1</h2>
<p>Google’s TPU v1 was put into production in 2015 and it was used internally by Google for their applications. In 2017 Google finally published a technical description of the chip called “In-Datacenter Performance Analysis of a Tensor Processing Unit” <span class="citation" data-cites="Jouppi2017In-DatacenterUnit">(<a href="#ref-Jouppi2017In-DatacenterUnit" role="doc-biblioref">N. P. Jouppi et al. 2017</a>)</span>.</p>
<p><br />
TPUv1 was designed as a coprocessor with a PCIe Gen3 x16 bus ( 12GB/s bandwidth). Similar to a GPU, it was designed to work with existing infrastructure and one server could be connected to 4 TPUs. A TPU is more like an FPU (Floating Point Unit) than a GPU because the host sends the instructions to the TPU whereas a GPU fetches the instructions on its own.</p>
<p>The central piece of the TPU is the MMU (Matrix Multiply Unit). This is the component that is based on systolic architectures. It contains 256x256 MAC (multiply and accumulate) units that can perform <em>8-bit multiplications and additions on signed or unsigned integers</em>. This means that:</p>
<p><span class="math display">\[T = 256*256\ ops * 700MHz\]</span> <span class="math display">\[= 45.2 T ops/s\]</span> These are just multiply operations. So, adding the addition operations, <span class="math display">\[T = 45.2 * 2 \approx 90 T ops/s\]</span></p>
<p>The weights for the matrix unit are staged through an on-chip Weight FIFO that reads from an off-chip 8 GB DRAM called Weight Memory (two 2133MHz DDR3 DRAM channels) for inference, weights are read-only. 8 GB supports many simultaneously active models.</p>
<p><br />
The 16-bit products are collected in the 4 MB of 32-bit Accumulators below the matrix unit. The 4MB represents 4096, 256-element, 32-bit accumulators.</p>
<p><br />
The matrix unit produces one 256-element partial sum per clock cycle. When using a mix of 8-bit weights and 16-bit activations (or vice versa), the Matrix Unit computes at half-speed, and it computes at a quarter-speed when both are 16 bits.The intermediate results are held in the 24 MB on-chip Unified Buffer, which can serve as inputs to the Matrix Unit. A programmable DMA controller transfers data to or from CPU Host memory and the Unified Buffer. The 24 MB Unified Buffer is almost a third of the die and the Matrix Multiply Unit is a quarter.<span class="citation" data-cites="Sato2017AnBlog">(<a href="#ref-Sato2017AnBlog" role="doc-biblioref">Sato, Young, and Patterson 2017</a>)</span></p>
<p><br />
The TPU ASIC is built on a 28nm process and consumes 40W when running (75W TDP). TPU implements the matrix multiplication with the systolic array in a pipeline fashion. It relies on data from different directions arriving at cells in an array at regular intervals and being combined.<br />
</p>
<figure>
<img src="images/TPUv1_Schematic-01.jpg" alt="The TPUv1 Schematic" /><figcaption aria-hidden="true">The TPUv1 Schematic</figcaption>
</figure>
<h2 id="tpuv2">TPUv2</h2>
<p>TPU v2 was unveiled at Google I/O in May 2017, two years later. While TPU v1 is a coprocessor, controlled by the host, TPU v2 and successors are Turing-complete and are suitable for both training and inference. Importantly, TPU v2 was built for multi-chip configurations because it became critical due to heavy production workloads — a single TPU v2 would take 60–400 days for some of them.</p>
<p><br />
A “Cloud TPU” is a TPU board with 4 TPU chips connected through PCI to a host virtual machine.</p>
<p><br />
Each TPU chip contains two cores with 8 GiB of HBM (high-bandwidth memory) and one matrix unit (MXU) for each TPU core. TPU v2 is connected to the host by PCIe Gen3 x32. The MXU provides the bulk of computing power in a TPU chip. Each MXU is capable of performing 16K (128x128) multiply-accumulate operations in each cycle at reduced bfloat16<span class="citation" data-cites="Wang2019BFloat16:TPUs">(<a href="#ref-Wang2019BFloat16:TPUs" role="doc-biblioref">Wang 2019</a>)</span><span class="citation" data-cites="Kalamkar2019ATrainingb">(<a href="#ref-Kalamkar2019ATrainingb" role="doc-biblioref">Kalamkar et al. 2019</a>)</span> (BF16) precision. It is supported by a vector processing unit that performs all the other computations in typical training workloads.<span class="citation" data-cites="Patterson201850Setb">(<a href="#ref-Patterson201850Setb" role="doc-biblioref">Patterson 2018</a>)</span></p>
<p><br />
Matrix multiplications are performed with BF16 inputs but all accumulations happen in FP32 so the resulting matrix is FP32<span class="citation" data-cites="Courbariaux2014TrainingMultiplications">(<a href="#ref-Courbariaux2014TrainingMultiplications" role="doc-biblioref">Courbariaux, Bengio, and David 2014</a>)</span>. All other computations are in FP32 except for results going directly to an MXU input, which are converted to BF16.<br />
</p>
<p>The Scalar Unit fetches VLIW<span class="citation" data-cites="Fisher1984TheCode">(<a href="#ref-Fisher1984TheCode" role="doc-biblioref">Fisher 1984</a>)</span> (Very Long Instruction Word) instructions from the core’s on-chip, software-managed Instruction Memory (Imem), executes scalar operations using a 4K 32-bit scalar data memory (Smem) and 32 32-bit scalar registers (Sregs), and forwards vector instructions to the Vector Unit. The 322-bit VLIW instruction can launch eight operations: two scalar, two vector ALU, vector load and store, and a pair of slots that queue data to and from the matrix multiply and transpose units. The XLA compiler<span class="citation" data-cites="PyTorch2020PyTorchXLA">(<a href="#ref-PyTorch2020PyTorchXLA" role="doc-biblioref">PyTorch 2020</a>)</span> schedules loading Imem via independent overlays of code, as unlike conventional CPUs, there is no instruction cache.</p>
<p><br />
The Vector Unit performs vector operations using a large on-chip vector memory (Vmem) with 32K 128 x 32-bit elements (16MB), and 32 2D vector registers (Vregs) each containing 128 x 8 32-bit elements (4 KB). The Vector Unit streams data to and from the MXU through decoupling FIFOs. The Vector Unit collects and distributes data to Vmem via data-level parallelism (2D matrix and vector functional units) and instruction- level parallelism (8 operations per instruction).</p>
<p><br />
The Transpose, Reduction, Permute Unit performs efficient common matrix transformations. ICI enables direct connections between chips (500 GB/s per link) to form a supercomputer using only 13% of each chip. Direct links simplify rack-level deployment, but in a multi-rack system, the racks must be adjacent. TPU v1 was memory bound for most of its applications. Engineers solved its memory bottleneck by using High Bandwidth Memory (HBM) DRAM in TPU v2 with 700 GB/s bandwidth instead of 34 GB/s bandwidth of DDR3 in TPU v1. More on memory speed here. TPU v2 delivers 22.5 TFLOPS per core, so 45 TFLOPS per chip and 180 TFLOPS per Cloud TPU card<span class="citation" data-cites="Shahid2020ANetworksb">(<a href="#ref-Shahid2020ANetworksb" role="doc-biblioref">Shahid and Mushtaq 2020</a>)</span>.<br />
</p>
<p><img src="images/TPUv2Core_Compiled-01.jpg" title="TPUv2 Compiled Schematic" /></p>
<h2 id="tpuv3">TPUv3</h2>
<p>TPU v3 was announced in May 2018 at Google I/O, only a year after the TPU v2. It’s rather a gradual evolution of TPU v2, or maybe “TPU v2 done right” (in one deck Google called it “The Anti-Second System”).</p>
<p>A “Cloud TPU v3” is still a TPU board with 4 TPU chips. Each TPU v3 chip contains two cores with 16 GB of HBM (increased size twice and bandwidth from 700 to 900 GB/s) and two matrix units (MXU) for each TPU core (instead of a single one in TPU v2). Now it is liquid-cooled (so the tubes on the photo).</p>
<p>TPU v3 delivers 420 TFLOPS per Cloud TPU card (due to twice the number of MXU and increased clock rate (940 MHz vs 700 MHz)<span class="citation" data-cites="Teich2018TearingCoprocessor">(<a href="#ref-Teich2018TearingCoprocessor" role="doc-biblioref">Teich 2018</a>)</span>.</p>
<h1 id="benchmarking-tpus">Benchmarking TPUs</h1>
<h2 id="methodology">Methodology</h2>
<p>The main idea is to benchmark individual operations of the TPU. The question then remains what operations should be benchmarked. The operations are divided into 4 categories:</p>
<ol type="1">
<li><p>Basic Functions (Add, subtract, multiply, divide, power, sqrt, abs, log, exp)</p></li>
<li><p>Activation Functions (ReLU, Leaky ReLU, sign, sigmoid, softplus, relu6, hardswish, mish, log-softmax, tanh)</p></li>
<li><p>Matrix Multiplication (dot product, 2-D dot product, 3-D dot product, 4-D dot product, 4-D sum, Matrix Multiplication)</p></li>
<li><p>Other Matrix Operations (Scalar multiplication, reverse scalar multiplication, subtract, reverse subtract)</p></li>
</ol>
<p>For each operation, a function stress_test is called that first generates a matrix of a randomly selected integer size between size <span class="math inline">\(2^i\)</span> and <span class="math inline">\(2^{i+1}\)</span> and <span class="math inline">\(i\)</span> is increased until the TPU/GPU cannot handle the computation (A GPU throws a CUDA out of memory error while a TPU crashes). The decision to select a random integer that’s not an exact power of 2 is based on the fact that these devices are optimized for sizes that are a power of 2. To get rid of this optimization factor and test raw power, the size is random and not a perfect power of 2.</p>
<h2 id="problems-encountered">Problems Encountered</h2>
<p>In order to compare TPUs and GPUs, I needed to rent a GPU in the cloud. However, Google was and still is refusing to grant my request for GPUs. I had to use GPUs available in the cloud and that presented a problem because Google Cloud run on a shared memory architecture. This means that the amount of memory in a system is not fixed. It varies depending on the current load on the system. This is problematic for benchmarking because the conditions cannot be controlled. I’ll update this document if the situation changes.</p>
<h2 id="results">Results</h2>
<p>On GitHub.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-Courbariaux2014TrainingMultiplications" class="csl-entry" role="doc-biblioentry">
Courbariaux, Matthieu, Yoshua Bengio, and Jean-Pierre David. 2014. <span>“<span class="nocase">Training deep neural networks with low precision multiplications</span>.”</span> <em>3rd International Conference on Learning Representations, ICLR 2015 - Workshop Track Proceedings</em>, no. Section 5 (December): 1–10. <a href="http://arxiv.org/abs/1412.7024">http://arxiv.org/abs/1412.7024</a>.
</div>
<div id="ref-Fisher1984TheCode" class="csl-entry" role="doc-biblioentry">
Fisher, Joseph A. 1984. <span>“<span class="nocase">The VLIW Machine: A Multiprocessor for Compiling Scientific Code</span>.”</span>
</div>
<div id="ref-Harris2005Mapping2" class="csl-entry" role="doc-biblioentry">
Harris, Mark. 2005. <span>“<span class="nocase">Mapping Computational Concepts to GPUs Chapter 31 Excerpted from GPU Gems 2</span>.”</span>
</div>
<div id="ref-Jouppi2017In-DatacenterUnit" class="csl-entry" role="doc-biblioentry">
Jouppi, Norman P., Cliff Young, Nishant Patil, David Patterson, Gaurav Agrawal, Raminder Bajwa, Sarah Bates, et al. 2017. <span>“<span class="nocase">In-Datacenter Performance Analysis of a Tensor Processing Unit</span>.”</span> <em>ACM SIGARCH Computer Architecture News</em> 45 (2): 1–12. <a href="https://doi.org/10.1145/3140659.3080246">https://doi.org/10.1145/3140659.3080246</a>.
</div>
<div id="ref-Jouppi2018MotivationUnitb" class="csl-entry" role="doc-biblioentry">
Jouppi, Norman, Cliff Young, Nishant Patil, and David Patterson. 2018. <span>“<span class="nocase">Motivation for and Evaluation of the First Tensor Processing Unit</span>.”</span> <em>IEEE Micro</em> 38 (3): 10–19. <a href="https://doi.org/10.1109/MM.2018.032271057">https://doi.org/10.1109/MM.2018.032271057</a>.
</div>
<div id="ref-Kalamkar2019ATrainingb" class="csl-entry" role="doc-biblioentry">
Kalamkar, Dhiraj, Dheevatsa Mudigere, Naveen Mellempudi, Dipankar Das, Kunal Banerjee, Sasikanth Avancha, Dharma Teja Vooturi, et al. 2019. <span>“<span class="nocase">A Study of BFLOAT16 for Deep Learning Training</span>,”</span> June. <a href="http://arxiv.org/abs/1905.12322">http://arxiv.org/abs/1905.12322</a>.
</div>
<div id="ref-Kung1982WhyArchitectures" class="csl-entry" role="doc-biblioentry">
Kung. 1982. <span>“<span class="nocase">Why systolic architectures?</span>”</span> <em>Computer</em> 15 (1): 37–46. <a href="https://doi.org/10.1109/MC.1982.1653825">https://doi.org/10.1109/MC.1982.1653825</a>.
</div>
<div id="ref-Milovanovic2010Forty-threeMultiplication" class="csl-entry" role="doc-biblioentry">
Milovanović, I. Ž., M P Bekakos, I N Tselepis, and E. I. Milovanović. 2010. <span>“<span class="nocase">Forty-three ways of systolic matrix multiplication</span>.”</span> <em>International Journal of Computer Mathematics</em> 87 (6): 1264–76. <a href="https://doi.org/10.1080/00207160802275944">https://doi.org/10.1080/00207160802275944</a>.
</div>
<div id="ref-Navarro2020GPUReductions" class="csl-entry" role="doc-biblioentry">
Navarro, Cristóbal A, Roberto Carrasco, Ricardo J Barrientos, Javier A Riquelme, and Raimundo Vega. 2020. <span>“<span class="nocase">GPU Tensor Cores for fast Arithmetic Reductions</span>,”</span> June. <a href="http://arxiv.org/abs/2001.05585">http://arxiv.org/abs/2001.05585</a>.
</div>
<div id="ref-Patterson201850Setb" class="csl-entry" role="doc-biblioentry">
Patterson, David. 2018. <span>“<span class="nocase">50 Years of computer architecture: From the mainframe CPU to the domain-specific tpu and the open RISC-V instruction set</span>.”</span> In <em>2018 IEEE International Solid - State Circuits Conference - (ISSCC)</em>, 27–31. IEEE. <a href="https://doi.org/10.1109/ISSCC.2018.8310168">https://doi.org/10.1109/ISSCC.2018.8310168</a>.
</div>
<div id="ref-PyTorch2020PyTorchXLA" class="csl-entry" role="doc-biblioentry">
PyTorch. 2020. <span>“<span>PyTorch XLA</span>.”</span> <a href="https://github.com/pytorch/xla">https://github.com/pytorch/xla</a>.
</div>
<div id="ref-Sato2017AnBlog" class="csl-entry" role="doc-biblioentry">
Sato, Kaz, Cliff Young, and David Patterson. 2017. <span>“<span class="nocase">An in-depth look at Google’s first Tensor Processing Unit (TPU) | Google Cloud Blog</span>.”</span>
</div>
<div id="ref-Shahid2020ANetworksb" class="csl-entry" role="doc-biblioentry">
Shahid, Amna, and Malaika Mushtaq. 2020. <span>“<span class="nocase">A Survey Comparing Specialized Hardware and Evolution in TPUs for Neural Networks</span>.”</span> In <em>Proceedings - 2020 23rd IEEE International Multi-Topic Conference, INMIC 2020</em>. Institute of Electrical; Electronics Engineers Inc. <a href="https://doi.org/10.1109/INMIC50486.2020.9318136">https://doi.org/10.1109/INMIC50486.2020.9318136</a>.
</div>
<div id="ref-Teich2018TearingCoprocessor" class="csl-entry" role="doc-biblioentry">
Teich, Paul. 2018. <span>“<span class="nocase">Tearing Apart Google ’ s TPU 3 . 0 AI Coprocessor</span>.”</span> <a href="https://www.nextplatform.com/2018/05/10/tearing-apart-googles-tpu-3-0-ai-coprocessor/">https://www.nextplatform.com/2018/05/10/tearing-apart-googles-tpu-3-0-ai-coprocessor/</a>.
</div>
<div id="ref-Wang2019BFloat16:TPUs" class="csl-entry" role="doc-biblioentry">
Wang, Shibo. 2019. <span>“<span class="nocase">BFloat16: The secret to high performance on Cloud TPUs</span>.”</span> <a href="https://cloud.google.com/blog/products/ai-machine-learning/bfloat16-the-secret-to-high-performance-on-cloud-tpus">https://cloud.google.com/blog/products/ai-machine-learning/bfloat16-the-secret-to-high-performance-on-cloud-tpus</a>.
</div>
<div id="ref-Williams2009Roofline:Architecturesb" class="csl-entry" role="doc-biblioentry">
Williams, Samuel, Andrew Waterman, and David Patterson. 2009. <span>“<span class="nocase">Roofline: An insightful visual performance model for multicore architectures</span>.”</span> <em>Communications of the ACM</em> 52 (4): 65–76. <a href="https://doi.org/10.1145/1498765.1498785">https://doi.org/10.1145/1498765.1498785</a>.
</div>
</div>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom">
<h3 id="references">References</h3>
<div id="references-listing"></div>
</div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
